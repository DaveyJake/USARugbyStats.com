<?php
use UsaRugbyStats\Competition\Form\Fieldset\Competition\Match\MatchTeamPlayerFieldset;
$this->layout()->cover = 'usa-rugby-stats/competition-frontend/competition/match/cover';
$this->layout()->coverVars = $this->vars();
$this->layout()->mainClasses = array_merge((array)$this->layout()->mainClasses, ['game']);

$homeSide = $this->match->getTeam('H');
$homeTeam = $homeSide->getTeam();
$homeTeamRoster = $homeSide->getPlayers();
$awaySide = $this->match->getTeam('A');
$awayTeam = $awaySide->getTeam();
$awayTeamRoster = $awaySide->getPlayers();

//@TODO this should be encapsulated by the Competition object
$maxPlayers = empty($this->match->getCompetition()->getMaxPlayersOnRoster())
    ? ( $this->match->getCompetition()->getVariant() == '7s' ? '15' : '23' )
    : $this->match->getCompetition()->getMaxPlayersOnRoster();

// Get list of positions for this rugby variant
$positions = array_keys(MatchTeamPlayerFieldset::$positions[$this->match->getCompetition()->getVariant()]);
?>
<div id="content" class="col-sm-7">
    <div class="panel">
        <div class="title">
    		<h2><span class="icon-list"></span>Game Stream</h2>
    		<?php if ( $this->isGranted('competition.competition.match.update', $this->match) && $this->match->isStarted() ): ?>
    		<a class="utility edit"><span class="icon-compose"></span>Add Event</a>
    		<?php endif; ?>
        </div>
        <table>
        	<thead>
        		<th>MIN</th>
        		<th>EVENT</th>
        		<th>TYPE</th>
        		<th>SIDE</th>
        		<th>PLAYER(S)</th>
        	</thead>
        	<?php foreach ($this->match->getEvents() as $event): ?>
        	<tr>
        		<td><?=$this->escapeHtml($event->getMinute());?>'</td>
        		<td><?=$this->escapeHtml($event->getEvent());?></td>
        		<td><?=$this->escapeHtml($event->getType());?></td>
        		<td><?=$this->escapeHtml($event->getTeam()->getType() == 'H' ? 'home' : 'away');?></td>
                <?php
                switch ( $event->getEvent() ) {
                    case 'score':
                        echo '<td>' . $this->ursPlayerLink($event->getPlayer()) . '</td>';
                        break;
                    case 'card':
                        echo '<td>' . $this->ursPlayerLink($event->getPlayer()) . '</td>';
                        break;
                    case 'sub':
                        echo '<td>';
                        echo 'Off: ' . $this->ursPlayerLink($event->getPlayerOff()) . '<br />';
                        echo 'On: ' . $this->ursPlayerLink($event->getPlayerOn()) . '<br />';
                        echo '</td>';
                        break;
                }
                ?>
        	</tr>
        	<?php endforeach; ?>
        </table>
    </div>
</div>

<aside class="col-sm-5" id="players">
    <div class="panel">
        <div class="title">
    		<h2><span class="icon-users"></span>Rosters</h2>
    		<?php if ( $this->isGranted('competition.competition.match.update', $this->match) && $this->match->isNotStarted() ): ?>
    		<a class="utility edit"><span class="icon-compose"></span>Edit Roster</a>
    		<?php endif; ?>
        </div>
        <table>
        	<thead>
        		<th class="home-player"><?=$this->escapeHtml($this->ursTeamName($homeTeam)); ?></th>
        		<th># - POS</th>
        		<th class="away-player"><?=$this->escapeHtml($this->ursTeamName($awayTeam)); ?></th>
        	</thead>
        	<?php foreach ( $positions as $poskey ): ?>
        	<?php   $homePlayer = $homeTeamRoster->get($poskey); ?>
        	<?php   $awayPlayer = $awayTeamRoster->get($poskey); ?>
        	<tr>
        		<td class="home-player"><?=$homePlayer ? $this->ursPlayerLink($homePlayer) : '--';?></td>
        		<td><?=$this->escapeHtml($poskey);?></td>
        		<td class="away-player"><?=$awayPlayer ? $this->ursPlayerLink($awayPlayer) : '--';?></td>
        	</tr>
        	<?php endforeach; ?>
        </table>
    </div>
</aside>
